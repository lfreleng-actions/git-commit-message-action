---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# Action test/validation workflow
name: 'Test GitHub Action ðŸ§ª'

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions: {}

jobs:
  ### Test the GitHub Action in this Repository ###
  tests:
    name: 'Test local GitHub Action'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        name: 'Harden runner'
        with:
          egress-policy: audit

      - name: 'Checkout repository'
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 5  # Ensure we have enough commits for testing

      - name: 'Setup test commits'
        shell: bash
        run: |
          # Create test commits with different message formats
          git config user.name 'Test User'
          git config user.email 'test@example.com'

          # Create a commit with DCO and Change-Id
          echo 'test-file-1' > test1.txt
          git add test1.txt
          git commit -m 'feat: Add test feature

          This commit includes both DCO and Change-Id.

          Change-Id: I1234567890abcdef1234567890abcdef12345678
          Signed-off-by: Test User <test@example.com>'

      - name: 'Test default behavior (latest commit)'
        id: test_default
        uses: ./

      - name: 'Validate default test outputs'
        shell: bash
        run: |
          if [ -z "${{ steps.test_default.outputs.commit_sha }}" ]; then
            echo "âŒ commit_sha is empty"
            exit 1
          fi

          if [ -z "${{ steps.test_default.outputs.commit_message }}" ]; then
            echo "âŒ commit_message is empty"
            exit 1
          fi

          echo "âœ… Default test passed"
          echo "SHA: ${{ steps.test_default.outputs.commit_sha }}"

      - name: "Test specific commit number"
        id: test_commit_2
        uses: ./
        with:
          commit_number: "2"

      - name: "Validate specific commit test"
        shell: bash
        run: |
          if [ -z "${{ steps.test_commit_2.outputs.commit_sha }}" ]; then
            echo "âŒ Second commit SHA is empty"
            exit 1
          fi

          # Should be different from first commit
          if [ "${{ steps.test_default.outputs.commit_sha }}" = \
               "${{ steps.test_commit_2.outputs.commit_sha }}" ]; then
            echo "âŒ Commit SHAs should be different"
            exit 1
          fi

          echo 'âœ… Specific commit test passed'

      - name: "Test DCO and Change-Id detection"
        shell: bash
        run: |
          # Test DCO detection
          if [ "${{ steps.test_default.outputs.dco_signed_off }}" != \
               'true' ]; then
            echo 'âŒ DCO not detected in latest commit'
            exit 1
          fi

          if [ "${{ steps.test_default.outputs.dco_name }}" != \
               'Test User' ]; then
            echo 'âŒ DCO name not extracted correctly'
            echo 'Expected: Test User'
            echo "Got: ${{ steps.test_default.outputs.dco_name }}"
            exit 1
          fi

          if [ "${{ steps.test_default.outputs.dco_email }}" != \
               'test@example.com' ]; then
            echo 'âŒ DCO email not extracted correctly'
            exit 1
          fi

          # Test Change-Id detection
          if [ "${{ steps.test_default.outputs.change_id }}" != \
               'true' ]; then
            echo 'âŒ Change-Id not detected'
            exit 1
          fi

          expected_change_id='I1234567890abcdef1234567890abcdef12345678'
          if [ "${{ steps.test_default.outputs.change_id_value }}" != \
               "$expected_change_id" ]; then
            echo 'âŒ Change-Id value not extracted correctly'
            exit 1
          fi

          echo 'âœ… DCO and Change-Id detection tests passed'

      - name: 'Test invalid commit number (should fail)'
        id: test_invalid
        uses: ./
        continue-on-error: true
        with:
          commit_number: 'abc'

      - name: 'Validate error handling'
        shell: bash
        run: |
          if [ "${{ steps.test_invalid.outcome }}" = "success" ]; then
            echo 'âŒ Action should have failed with invalid input'
            exit 1
          fi

          echo 'âœ… Error handling test passed'

      - name: 'Test commit without DCO or Change-Id'
        shell: bash
        run: |
          # Create commit without DCO or Change-Id
          echo 'test-file-2' > test2.txt
          git add test2.txt
          git commit -m 'Simple commit without DCO or Change-Id'

      - name: 'Test missing DCO and Change-Id'
        id: test_no_dco
        uses: ./

      - name: 'Validate missing DCO/Change-Id detection'
        shell: bash
        run: |
          if [ "${{ steps.test_no_dco.outputs.dco_signed_off }}" != \
               'false' ]; then
            echo 'âŒ Should detect missing DCO'
            exit 1
          fi

          if [ "${{ steps.test_no_dco.outputs.change_id }}" != \
               'false' ]; then
            echo 'âŒ Should detect missing Change-Id'
            exit 1
          fi

          echo 'âœ… Missing DCO/Change-Id detection passed'

      - name: 'Test summary'
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## ðŸ§ª Action Test Results
          - âœ… Default behavior test
          - âœ… Specific commit number test
          - âœ… DCO and Change-Id detection
          - âœ… Error handling test
          - âœ… Missing DCO/Change-Id detection

          All tests completed successfully! ðŸŽ‰
          EOF
